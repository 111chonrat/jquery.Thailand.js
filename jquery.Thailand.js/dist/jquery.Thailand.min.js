/**
 * @name jquery.Thailand.js
 * @version 1.4.0
 * @update Apr 18, 2017
 * @website https://github.com/earthchie/jquery.Thailand.js
 * @license WTFPL v.2 - http://www.wtfpl.net/
 *
 * @dependencies: jQuery <https://jquery.com/>
 *              JSZIP <https://stuk.github.io/jszip/>
 *              typeahead.js <https://twitter.github.io/typeahead.js/>
 *              JQL.js <https://github.com/earthchie/JQL.js>
 **/
$.Thailand=function(a){"use strict";a=$.extend({database:"../database/db.json",database_type:"auto",autocomplete_size:20,onLoad:function(){},onDataFill:function(){},$district:!1,$amphoe:!1,$province:!1,$zipcode:!1,$search:!1},a);var b=function(a){var f,b=[],c=[],d=[],e=!1;return a.lookup&&a.words&&(e=!0,b=a.lookup.split("|"),c=a.words.split("|"),a=a.data),f=function(a){function d(a){var b=a.charCodeAt(0);return c[b<97?b-65:26+b-97]}return e?("number"==typeof a&&(a=b[a]),a.replace(/[A-Z]/gi,d)):a},a[0].length?(a.map(function(a){a[1].map(function(b){b[1].map(function(c){c[1]=c[1]instanceof Array?c[1]:[c[1]],c[1].map(function(e){d.push({d:f(c[0]),a:f(b[0]),p:f(a[0]),z:e})})})})}),d):a},c=function(a,b,d){a+="",b+="";var j,k,l,m,e=0,f=0,g=0,h=a.length,i=b.length;for(j=0;j<h;j+=1)for(k=0;k<i;k+=1){for(l=0;j+l<h&&k+l<i&&a.charAt(j+l)===b.charAt(k+l);)l+=1;l>g&&(g=l,e=j,f=k)}return m=g,m&&(e&&f&&(m+=c(a.substr(0,f),b.substr(0,f),!1)),e+g<h&&f+g<i&&(m+=c(a.substr(e+g,h-e-g),b.substr(f+g,i-f-g),!1))),!1===d?m:a===b?100:h>i?Math.floor(m/h*100):Math.floor(m/i*100)};!function(c){var d=a.database_type.toLowerCase();switch("json"!==d&&"zip"!==d&&(d=a.database.split(".").pop()),d){case"json":$.getJSON(a.database,function(a){c(new JQL(b(a)))}).fail(function(b){throw new Error('File "'+a.database+'" is not exists.')});break;case"zip":a.database_type="zip",JSZipUtils.getBinaryContent(a.database,function(d,e){if(d)throw new Error('File "'+a.database+'" is not exists.');JSZip.loadAsync(e).then(function(a){a.file("db.json").async("string").then(function(a){c(new JQL(b(JSON.parse(a))))})})});break;default:throw new Error('Unknown database type: "'+a.database_type+'". Please define database_type explicitly (json or zip)')}}(function(b){var d={hint:!0,highlight:!0,minLength:1},e={empty:" ",suggestion:function(a){return"<div>"+a.d+" » "+a.a+" » "+a.p+" » "+(a.z||"<i>ไม่มีรหัสไปรษณีย์</i>")+"</div>"}},f=function(b,c){a.$district&&a.$district.typeahead("val",c.d).trigger("change"),a.$amphoe&&a.$amphoe.typeahead("val",c.a).trigger("change"),a.$province&&a.$province.typeahead("val",c.p).trigger("change"),a.$zipcode&&a.$zipcode.typeahead("val",c.z).trigger("change"),"function"==typeof a.onDataFill&&a.onDataFill({district:c.d,amphoe:c.a,province:c.p,zipcode:c.z})};a.$district&&a.$district.typeahead(d,{limit:a.autocomplete_size,templates:e,source:function(a,c){var d=[];try{d=b.select("*").where("d").match("^"+a).orderBy("d").fetch()}catch(a){}c(d)},display:function(a){return a.d}}),a.$amphoe&&a.$amphoe.typeahead(d,{limit:a.autocomplete_size,templates:e,source:function(a,c){var d=[];try{d=b.select("*").where("a").match("^"+a).orderBy("a").fetch()}catch(a){}c(d)},display:function(a){return a.a}}),a.$province&&a.$province.typeahead(d,{limit:a.autocomplete_size,templates:e,source:function(a,c){var d=[];try{d=b.select("*").where("p").match("^"+a).orderBy("p").fetch()}catch(a){}c(d)},display:function(a){return a.p}}),a.$zipcode&&a.$zipcode.typeahead(d,{limit:a.autocomplete_size,templates:e,source:function(a,c){var d=[];try{d=b.select("*").where("z").match("^"+a).orderBy("z").fetch()}catch(a){}c(d)},display:function(a){return a.z}}),a.$search&&a.$search.typeahead({hint:!0,highlight:!0,minLength:2},{limit:a.autocomplete_size,templates:e,source:function(a,d){var f,e=[];try{e=new JQL(e.concat(b.select("*").where("d").match(a).fetch()).concat(b.select("*").where("a").match(a).fetch()).concat(b.select("*").where("p").match(a).fetch()).concat(b.select("*").where("z").match(a).fetch()).filter(function(a,b,c){for(f=0;f<c.length;f+=1)if(b!==f&&c[f].a===a.d&&c[f].d===a.d)return!1;return!0}).map(function(b){return b.likely=[5*c(a,b.d),3*c(a,b.a.replace(/^เมือง/,"")),c(a,b.p),c(a,b.z)].reduce(function(a,b){return Math.max(a,b)}),b})).select("*").orderBy("likely desc").fetch()}catch(a){}d(e)},display:function(a){return""}}),[a.$district,a.$amphoe,a.$province,a.$zipcode,a.$search].map(function(a){a&&a.bind("typeahead:select typeahead:autocomplete",f).blur(function(){this.value||$(this).parent().find(".tt-dataset").html("")})}),"function"==typeof a.onLoad&&a.onLoad(),"function"==typeof a.onComplete&&a.onComplete()})};